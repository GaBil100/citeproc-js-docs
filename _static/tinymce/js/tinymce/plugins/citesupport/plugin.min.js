tinymce.PluginManager.add("citesupport",function(a){"use strict";function b(a){this.editor=a,this.config={debug:!0,mode:"note",defaultLocale:"en-US",defaultStyle:"american-medical-association",citationIdToPos:{},citationByIndex:[],processorReady:!1,demo:!0};var b=this;this.worker=new Worker("_static/js/citeworker.js"),this.worker.onmessage=function(a){switch(a.data.command){case"initProcessor":b.debug("initProcessor()"),b.config.mode=a.data.xclass;var c=b.convertRebuildDataToCitationData(a.data.rebuildData);b.setCitations(b.config.mode,c),b.setBibliography(a.data.bibliographyData),b.config.processorReady=!0;break;case"registerCitation":b.debug("registerCitation()"),b.config.citationByIndex=a.data.citationByIndex,b.setCitations(b.config.mode,a.data.citationData,!0),b.setBibliography(a.data.bibliographyData),b.config.processorReady=!0}}}b.prototype.debug=function(a){this.config.debug&&console.log("*** "+a)},b.prototype.callInitProcessor=function(a,b,c){this.debug("callInitProcessor()"),this.config.processorReady=!1,c||(c=[]),this.worker.postMessage({command:"initProcessor",styleName:a,localeName:b,citationByIndex:c})},b.prototype.callRegisterCitation=function(a,b,c){this.config.processorReady&&(this.debug("callRegisterCitation()"),this.config.processorReady=!1,this.worker.postMessage({command:"registerCitation",citation:a,preCitations:b,postCitations:c}))},b.prototype.convertRebuildDataToCitationData=function(a){if(a){this.debug("convertRebuildDataToCitationData()");for(var b=a.map(function(a){return[0,a[2],a[0]]}),c=0,d=b.length;d>c;c++)b[c][0]=c;return b}},b.prototype.initDocument=function(){this.debug("initDocument()"),this.spoofDocument(),this.callInitProcessor(this.config.defaultStyle,this.config.defaultLocale,this.config.citationByIndex)},b.prototype.setCitations=function(a,b){this.debug("setCitations()");var c=this.editor.getBody(),d=this.editor.getDoc().getElementById("footnote-container"),e=this.editor.getDoc().getElementById("bibliography-container"),f=this.editor.getDoc().getElementById("citesupport-data-container");if(!e){var g=this.editor.getDoc().createElement("div");g.setAttribute("id","bibliography-container"),g.classList.add("mceNonEditable"),g.setAttribute("contenteditable","false"),g.hidden=!0,g.innerHTML='<h2>Bibliography</h2><div id="bibliography"></div>',c.appendChild(g)}if(!d){var h=this.editor.getDoc().createElement("div");h.setAttribute("id","footnote-container"),h.classList.add("mceNonEditable"),h.setAttribute("contenteditable","false"),h.hidden=!0,h.innerHTML='<div class="footnote-header"><b>Footnotes</b></div><div id="footnotes"></div>',c.insertBefore(h,g)}if(!f){var i=this.editor.getDoc().createElement("div");i.setAttribute("id","citesupport-data-container"),i.classList.add("mceNonEditable"),i.setAttribute("contenteditable","false"),i.hidden=!0,c.appendChild(i),f=this.editor.getDoc().getElementById("citesupport-data-container")}for(var j=this.pruneNodeList(this.editor.getDoc().getElementsByClassName("citation")),k=0,l=b.length;l>k;k++){var m=j[b[k][0]],n=b[k][2];m.hasAttribute("id")||m.setAttribute("id",n)}for(var k=0,l=j.length;l>k;k++){var n=j[k].id;this.config.citationIdToPos[n]=k}for(var k=0,l=b.length;l>k;k++){var o=this.editor.getDoc().getElementById("csdata-"+b[k][2]);if(o){var p=btoa(JSON.stringify(this.config.citationByIndex[this.config.citationIdToPos[b[k][2]]]));o.innerHTML=p}else{o=this.editor.getDoc().createElement("div"),o.setAttribute("id","csdata-"+b[k][2]),o.classList.add("citation-data");var p=btoa(JSON.stringify(this.config.citationByIndex[this.config.citationIdToPos[b[k][2]]]));o.innerHTML=p,f.appendChild(o)}}if("note"===a){var d=this.editor.getDoc().getElementById("footnote-container");b.length?d.hidden=!1:d.hidden=!0;for(var k=0,l=b.length;l>k;k++){var q=b[k],n=q[2],m=this.editor.getDoc().getElementById(n),r=q[1],s=q[0],t=s+1;m.innerHTML='<span class="footnote-mark">'+t+'</span><span hidden="true">'+r+"</span>"}for(var u=this.editor.getDoc().getElementsByClassName("footnote-mark"),k=0,l=u.length;l>k;k++){var v=u[k];v.innerHTML=k+1}for(var w=this.editor.getDoc().getElementById("footnotes"),k=w.childNodes.length-1;k>-1;k--)w.removeChild(w.childNodes[k]);for(var j=this.pruneNodeList(this.editor.getDoc().getElementsByClassName("citation")),k=0,l=j.length;l>k;k++){var x=j[k].childNodes[1].innerHTML,t=k+1,y=this.editor.getDoc().createElement("p");y.classList.add("footnote"),y.innerHTML='<span class="footnote"><span class="footnote-number">'+t+'</span><span class="footnote-text">'+x+"</span></span>",w.appendChild(y)}}else{var d=this.editor.getDoc().getElementById("footnote-container");d.hidden=!0;for(var k=0,l=b.length;l>k;k++){var q=b[k],n=q[2],m=this.editor.getDoc().getElementById(n),r=q[1];m.innerHTML=r}}},b.prototype.setBibliography=function(a){this.debug("setBibliography()");var b=this.editor.getDoc().getElementById("bibliography-container");if(!a||!a[1]||0===a[1].length)return void(b.hidden=!0);var c=this.editor.getDoc().getElementById("bibliography");c.setAttribute("style","visibility: hidden;"),c.innerHTML=a[1].join("\n");var d=this.editor.getDoc().getElementsByClassName("csl-entry");if(a[0].hangingindent){for(var e=0,f=d.length;f>e;e++){var g=d[e];g.setAttribute("style","padding-left: 1.3em;text-indent: -1.3em;")}b.hidden=!1,c.setAttribute("style","visibility: visible;")}else if(a[0]["second-field-align"]){var h="padding-right:0.3em;";a[0].maxoffset&&(h="width: "+(a[0].maxoffset/2+.5)+"em;");for(var e=0,f=d.length;f>e;e++){var g=d[e];g.setAttribute("style","white-space: nowrap;")}for(var i=this.editor.getDoc().getElementsByClassName("csl-left-margin"),e=0,f=i.length;f>e;e++){var j=i[e];j.setAttribute("style","display:inline-block;vertical-align:top;"+h)}if(a[0].maxoffset){var k="",l=this.editor.getDoc().getElementsByClassName("csl-right-inline"),m=this.editor.getDoc().getElementById("tinymce").offsetWidth,n=10*a[0].maxoffset;k="width:"+(m-n-20)+"px;";for(var e=0,f=l.length;f>e;e++){var o=l[e];o.setAttribute("style","display: inline-block;white-space: normal;"+k)}b.hidden=!1,c.setAttribute("style","visibility: visible;")}else b.hidden=!1,c.setAttribute("style","visibility: visible;")}else b.hidden=!1,c.setAttribute("style","visibility: visible;")},b.prototype.pruneNodeList=function(a){for(var b=[],c=0,d=a.length;d>c;c++)a[c].parentNode.classList.contains("mce-offscreen-selection")||b.push(a[c]);return b},b.prototype.spoofDocument=function(){this.debug("spoofDocument()"),this.config.citationIdToPos={};for(var a=this.pruneNodeList(this.editor.getDoc().getElementsByClassName("citation")),b=0,c=a.length;c>b;b++){var d=a[b].id;this.config.citationIdToPos[d]=b}var e=this.editor.getDoc().getElementById("citesupport-style-container");e&&(this.config.defaultStyle=e.innerHTML);var f=this.editor.getDoc().getElementById("citesupport-data-container");if(f){for(var g=[],b=0,c=f.children.length;c>b;b++){var h=f.children[b];if(h.classList&&h.classList.contains("citation-data")){var i=JSON.parse(atob(h.innerHTML));g.push({seq:this.config.citationIdToPos[i.citationID],citation:i})}}g.sort(function(a,b){return a.seq>b.seq?1:a.seq<b.seq?-1:0}),this.config.citationByIndex=g.map(function(a){return a.citation})}else this.config.citationByIndex=[],this.config.citationIdToPos={};for(var j=this.editor.getDoc().getElementsByClassName("citation-data"),b=j.length-1;b>-1;b--)"number"!=typeof this.config.citationIdToPos[j.id]&&j[b].parentNode.removeChild(j[b]);for(var b=(this.pruneNodeList(this.editor.getDoc().getElementsByClassName("citation")),this.config.citationByIndex.length-1);b>-1;b--){var k=this.config.citationByIndex[b],d=k?k.citationID:null;"number"!=typeof this.config.citationIdToPos[d]&&(this.debug("WARNING: invalid state data. Removing offending citation record."),this.config.citationByIndex=this.config.citationByIndex.slice(0,b).concat(this.config.citationByIndex.slice(b+1)))}var l=this.config.citationByIndex.length,m=this.pruneNodeList(this.editor.getDoc().getElementsByClassName("citation")).length;if(l!==m){this.debug("WARNING: document citation node and citation object counts do not match. Removing citations."),this.config.citationByIndex=[],this.config.citationIdToPos={};for(var n=this.editor.getDoc().getElementsByClassName("citation"),b=0,c=n.length;c>b;b++)n[0].parentNode.removeChild(n[0])}};var c=new b(a);this.citesupport=c,window.addEventListener("load",function(a){c.initDocument()})});