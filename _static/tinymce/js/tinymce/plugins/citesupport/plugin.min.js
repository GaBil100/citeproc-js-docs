tinymce.PluginManager.add("citesupport",function(a){"use strict";function b(a){this.editor=a,this.config={debug:!0,mode:"note",defaultLocale:"en-US",defaultStyle:"american-medical-association",citationIdToPos:{},citationByIndex:[],processorReady:!1,demo:!0};var b=this;this.worker=new Worker("_static/js/citeworker.js"),this.worker.onmessage=function(a){switch(a.data.command){case"initProcessor":b.debug("initProcessor()"),b.config.mode=a.data.xclass;var c=b.convertRebuildDataToCitationData(a.data.rebuildData);b.setCitations(b.config.mode,c),b.setBibliography(a.data.bibliographyData),b.config.processorReady=!0;break;case"registerCitation":b.debug("registerCitation()"),b.config.citationByIndex=a.data.citationByIndex,b.setCitations(b.config.mode,a.data.citationData,!0),b.setBibliography(a.data.bibliographyData),b.config.processorReady=!0}}}b.prototype.debug=function(a){this.config.debug&&console.log("*** "+a)},b.prototype.callInitProcessor=function(a,b,c){this.debug("callInitProcessor()"),this.config.processorReady=!1,c||(c=[]),this.worker.postMessage({command:"initProcessor",styleName:a,localeName:b,citationByIndex:c})},b.prototype.callRegisterCitation=function(a,b,c){this.config.processorReady&&(this.debug("callRegisterCitation()"),this.config.processorReady=!1,this.worker.postMessage({command:"registerCitation",citation:a,preCitations:b,postCitations:c}))},b.prototype.convertRebuildDataToCitationData=function(a){if(a){this.debug("convertRebuildDataToCitationData()");for(var b=a.map(function(a){return[0,a[2],a[0]]}),c=0,d=b.length;d>c;c++)b[c][0]=c;return b}},b.prototype.initDocument=function(){this.debug("initDocument()"),this.spoofDocument(),this.callInitProcessor(this.config.defaultStyle,this.config.defaultLocale,this.config.citationByIndex)},b.prototype.setCitations=function(a,b){this.debug("setCitations()");var c=this.editor.getDoc(),d=this.editor.getBody(),e=c.getElementById("footnote-container"),f=c.getElementById("bibliography-container"),g=c.getElementById("citesupport-data-container");if(!f){var h=c.createElement("div");h.setAttribute("id","bibliography-container"),h.classList.add("mceNonEditable"),h.setAttribute("contenteditable","false"),h.hidden=!0,h.innerHTML='<h2>Bibliography</h2><div id="bibliography"></div>',d.appendChild(h)}if(!e){var i=c.createElement("div");i.setAttribute("id","footnote-container"),i.classList.add("mceNonEditable"),i.setAttribute("contenteditable","false"),i.hidden=!0,i.innerHTML='<div class="footnote-header"><b>Footnotes</b></div><div id="footnotes"></div>',d.insertBefore(i,h)}if(!g){var j=c.createElement("div");j.setAttribute("id","citesupport-data-container"),j.classList.add("mceNonEditable"),j.setAttribute("contenteditable","false"),j.hidden=!0,d.appendChild(j),g=c.getElementById("citesupport-data-container")}for(var k=this.pruneNodeList(c.getElementsByClassName("citation")),l=0,m=b.length;m>l;l++){var n=k[b[l][0]],o=b[l][2];n.hasAttribute("id")||n.setAttribute("id",o)}for(var l=0,m=k.length;m>l;l++){var o=k[l].id;this.config.citationIdToPos[o]=l}for(var l=0,m=b.length;m>l;l++){var p=c.getElementById("csdata-"+b[l][2]);if(p){var q=btoa(JSON.stringify(this.config.citationByIndex[this.config.citationIdToPos[b[l][2]]]));p.innerHTML=q}else{p=c.createElement("div"),p.setAttribute("id","csdata-"+b[l][2]),p.classList.add("citation-data");var q=btoa(JSON.stringify(this.config.citationByIndex[this.config.citationIdToPos[b[l][2]]]));p.innerHTML=q,g.appendChild(p)}}if("note"===a){var e=c.getElementById("footnote-container");b.length?e.hidden=!1:e.hidden=!0;for(var l=0,m=b.length;m>l;l++){var r=b[l],o=r[2],n=c.getElementById(o),s=r[1],t=r[0],u=t+1;n.innerHTML='<span class="footnote-mark">'+u+'</span><span hidden="true">'+s+"</span>"}for(var v=c.getElementsByClassName("footnote-mark"),l=0,m=v.length;m>l;l++){var w=v[l];w.innerHTML=l+1}for(var x=c.getElementById("footnotes"),l=x.childNodes.length-1;l>-1;l--)x.removeChild(x.childNodes[l]);for(var k=this.pruneNodeList(c.getElementsByClassName("citation")),l=0,m=k.length;m>l;l++){var y=k[l].childNodes[1].innerHTML,u=l+1,z=c.createElement("p");z.classList.add("footnote"),z.innerHTML='<span class="footnote"><span class="footnote-number">'+u+'</span><span class="footnote-text">'+y+"</span></span>",x.appendChild(z)}}else{var e=c.getElementById("footnote-container");e.hidden=!0;for(var l=0,m=b.length;m>l;l++){var r=b[l],o=r[2],n=c.getElementById(o),s=r[1];n.innerHTML=s}}},b.prototype.setBibliography=function(a){this.debug("setBibliography()");var b=this.editor.getDoc(),c=(this.editor.getBody(),b.getElementById("bibliography-container"));if(!a||!a[1]||0===a[1].length)return void(c.hidden=!0);var d=b.getElementById("bibliography");d.setAttribute("style","visibility: hidden;"),d.innerHTML=a[1].join("\n");var e=b.getElementsByClassName("csl-entry");if(a[0].hangingindent){for(var f=0,g=e.length;g>f;f++){var h=e[f];h.setAttribute("style","padding-left: 1.3em;text-indent: -1.3em;")}c.hidden=!1,d.setAttribute("style","visibility: visible;")}else if(a[0]["second-field-align"]){var i="padding-right:0.3em;";a[0].maxoffset&&(i="width: "+(a[0].maxoffset/2+.5)+"em;");for(var f=0,g=e.length;g>f;f++){var h=e[f];h.setAttribute("style","white-space: nowrap;"),alert("set to nowrap")}for(var j=b.getElementsByClassName("csl-left-margin"),f=0,g=j.length;g>f;f++){var k=j[f];k.setAttribute("style","display:inline-block;vertical-align:top;"+i)}if(a[0].maxoffset){var l="";alert("Test");var m=b.getElementsByClassName("csl-right-inline"),n=b.getElementById("tinymce").offsetWidth;alert("containerWidth="+n);var o=10*a[0].maxoffset;alert("numberWidth="+o),l="width:"+(n-o-20)+"px;",alert("widthSpec="+l);for(var f=0,g=m.length;g>f;f++){var p=m[f];alert("set to normal"),p.setAttribute("style","display: inline-block;white-space: normal;"+l)}c.hidden=!1,d.setAttribute("style","visibility: visible;")}else c.hidden=!1,d.setAttribute("style","visibility: visible;")}else c.hidden=!1,d.setAttribute("style","visibility: visible;")},b.prototype.pruneNodeList=function(a){for(var b=[],c=0,d=a.length;d>c;c++)a[c].parentNode.classList.contains("mce-offscreen-selection")||b.push(a[c]);return b},b.prototype.spoofDocument=function(){this.debug("spoofDocument()");var a=this.editor.getDoc();this.config.citationIdToPos={};for(var b=this.pruneNodeList(a.getElementsByClassName("citation")),c=0,d=b.length;d>c;c++){var e=b[c].id;this.config.citationIdToPos[e]=c}var f=a.getElementById("citesupport-style-container");f&&(this.config.defaultStyle=f.innerHTML);var g=a.getElementById("citesupport-data-container");if(g){for(var h=[],c=0,d=g.children.length;d>c;c++){var i=g.children[c];if(i.classList&&i.classList.contains("citation-data")){var j=JSON.parse(atob(i.innerHTML));h.push({seq:this.config.citationIdToPos[j.citationID],citation:j})}}h.sort(function(a,b){return a.seq>b.seq?1:a.seq<b.seq?-1:0}),this.config.citationByIndex=h.map(function(a){return a.citation})}else this.config.citationByIndex=[],this.config.citationIdToPos={};for(var k=a.getElementsByClassName("citation-data"),c=k.length-1;c>-1;c--)"number"!=typeof this.config.citationIdToPos[k.id]&&k[c].parentNode.removeChild(k[c]);for(var c=(this.pruneNodeList(a.getElementsByClassName("citation")),this.config.citationByIndex.length-1);c>-1;c--){var l=this.config.citationByIndex[c],e=l?l.citationID:null;"number"!=typeof this.config.citationIdToPos[e]&&(this.debug("WARNING: invalid state data. Removing offending citation record."),this.config.citationByIndex=this.config.citationByIndex.slice(0,c).concat(this.config.citationByIndex.slice(c+1)))}var m=this.config.citationByIndex.length,n=this.pruneNodeList(a.getElementsByClassName("citation")).length;if(m!==n){this.debug("WARNING: document citation node and citation object counts do not match. Removing citations."),this.config.citationByIndex=[],this.config.citationIdToPos={};for(var o=a.getElementsByClassName("citation"),c=0,d=o.length;d>c;c++)o[0].parentNode.removeChild(o[0])}};var c=new b(a);this.citesupport=c,window.addEventListener("load",function(a){c.initDocument()})});