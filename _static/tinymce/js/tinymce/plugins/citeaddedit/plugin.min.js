tinymce.PluginManager.add("citeaddedit",function(a){function b(a){for(var b=[],c=null,d=0,e=g.config.citationByIndex.length;e>d;d++)if(g.config.citationByIndex[d].citationID===a){c=g.config.citationByIndex[d];break}return c&&(b=c.citationItems.map(function(a){return a.id})),b}function c(){for(var a=[],b=[{title:"Geller 2002",id:"item01"},{title:"West 1934",id:"item02"},{title:"Allen 1878",id:"item03"},{title:"American case",id:"item04"},{title:"British case",id:"item05"}],c=0,d=b.length;d>c;c++)a.push({type:"checkbox",name:b[c].id,label:" ",text:b[c].title,value:b[c].id});return a}function d(a,b){for(var c=0,d=b.length;d>c;c++)for(var e=b[c],f=0,g=a.length;g>f;f++)e===a[f].name&&(a[f].checked=!0);return a}function e(a){for(var b=[],c=0,d=a.length;d>c;c++)a[c].parentNode.classList.contains("mce-offscreen-selection")||b.push(a[c]);return b}function f(){var f=a.selection.getNode(),h="",i="SPAN"==f.tagName&&a.dom.hasClass(f,"citation");i&&(h=f.id||"");for(var j=e(a.getDoc().getElementsByClassName("citation")),k=[],l={},m=0,n=j.length;n>m;m++){var o=j[m],p=g.config.citationIdToPos[o.id],q=g.config.citationByIndex[p];"undefined"!=typeof l[o.id]?(q=JSON.parse(JSON.stringify(q)),delete q.citationID):l[o.id]=m,k.push(q)}g.config.citationByIndex=k,g.config.citationIdToPos=l;var r=c(),s=b(h),r=d(r,s);a.windowManager.open({title:"Add/Edit citation",body:r,onsubmit:function(b){var c=[];for(var d in b.data)b.data[d]&&c.push({id:d});var f;if(i){if(h){var j=g.config.citationIdToPos[h];if(c.length)f=g.config.citationByIndex[j],f.citationItems=c;else if(g.config.citationByIndex=k.slice(0,j).concat(k.slice(j+1)),delete g.config.citationIdToPos[h],0===g.config.citationByIndex.length)callInitProcessor();else{f=g.config.citationByIndex[0];var l=g.editor.getDoc().getElementById(h);l.parentNode.removeChild(l)}}}else{if(!c.length)return;a.selection.collapse(!0),a.execCommand("mceInsertContent",!1,'<span class="citation mceNonEditable">{Citation}</span>'),f={citationItems:c,properties:{noteIndex:0}}}for(var m=e(a.getDoc().getElementsByClassName("citation")),n=[],o=[],p=0,q=0,r=m.length;r>q;q++){var l=m[q];if(l.id===h||!l.id){var p=0;i&&(p=1),g.config.citationByIndex.slice(0,q).length&&(n=g.config.citationByIndex.slice(0,q).map(function(a){return[a.citationID,0]})),g.config.citationByIndex.slice(q+p).length&&(o=g.config.citationByIndex.slice(q+p).map(function(a){return[a.citationID,0]}));break}}if("note"===g.config.mode){for(var q=0,r=n.length;r>q;q++)n[q][1]=q+1;var p=n.length+1;f.properties.noteIndex=p;for(var q=0,r=o.length;r>q;q++)o[q][1]=q+p+1}console.log("citation: "+f.citationID),console.log("citationsPre: "+JSON.stringify(n)),console.log("citationsPost: "+JSON.stringify(o)),g.callRegisterCitation(f,n,o)}})}var g=a.plugins.citesupport.citesupport;a.addCommand("mceCite",f),a.addButton("citeaddedit",{icon:!1,text:"Add/Edit citation",onclick:f}),a.addMenuItem("citeaddedit",{icon:!1,text:"AddEdit citation",context:"insert",onclick:f})});