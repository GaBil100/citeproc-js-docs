tinymce.PluginManager.add("citeaddedit",function(a){function b(a){for(var b=[],c=null,d=0,e=g.config.citationByIndex.length;e>d;d++)if(g.config.citationByIndex[d].citationID===a){c=g.config.citationByIndex[d];break}return c&&(b=c.citationItems.map(function(a){return a.id})),b}function c(){for(var a=[],b=[{title:"Geller 2002",id:"item01"},{title:"West 1934",id:"item02"},{title:"Allen 1878",id:"item03"},{title:"American case",id:"item04"},{title:"British case",id:"item05"}],c=0,d=b.length;d>c;c++)a.push({type:"checkbox",name:b[c].id,label:" ",text:b[c].title,value:b[c].id});return a}function d(a,b){for(var c=0,d=b.length;d>c;c++)for(var e=b[c],f=0,g=a.length;g>f;f++)e===a[f].name&&(a[f].checked=!0);return a}function e(a){for(var b=[],c=0,d=a.length;d>c;c++)a[c].parentNode.classList.contains("mce-offscreen-selection")||b.push(a[c]);return b}function f(){var f=a.selection.getNode(),h="",i="SPAN"==f.tagName&&a.dom.hasClass(f,"citation");i&&(h=f.id||""),g.config.citationByIndex=g.spoofCitations();var j=c(),k=b(h),j=d(j,k);a.windowManager.open({title:"Add/Edit citation",body:j,onsubmit:function(b){var c=[];for(var d in b.data)b.data[d]&&c.push({id:d});var j;if(i){if(h)if(j=f,c.length)j.citationItems=c;else{for(var k=e(doc.getElementsByClassName("citation")),l=-1,m=0;m<k.length;m++)if(k[m]===j){l=m;break}if(g.config.citationByIndex=g.config.citationByIndex.slice(0,l).concat(g.config.citationByIndex.slice(l+1)),0===g.config.citationByIndex.length)return void callInitProcessor();j=g.config.citationByIndex[0];var n=g.editor.getDoc().getElementById(h);n.parentNode.removeChild(n)}}else{if(!c.length)return;a.selection.collapse(!0),a.execCommand("mceInsertContent",!1,'<span class="citation mceNonEditable">{Citation}</span>'),j={citationItems:c,properties:{noteIndex:0}}}for(var o=e(a.getDoc().getElementsByClassName("citation")),p=[],q=[],r=0,m=0,s=o.length;s>m;m++){var n=o[m];if(n===j){var r=0;i&&(r=1),g.config.citationByIndex.slice(0,m).length&&(p=g.config.citationByIndex.slice(0,m).map(function(a){return[a.citationID,0]})),g.config.citationByIndex.slice(m+r).length&&(q=g.config.citationByIndex.slice(m+r).map(function(a){return[a.citationID,0]}));break}}if("note"===g.config.mode){for(var m=0,s=p.length;s>m;m++)p[m][1]=m+1;var r=p.length+1;j.properties.noteIndex=r;for(var m=0,s=q.length;s>m;m++)q[m][1]=m+r+1}console.log("citation: "+j.citationID),console.log("citationsPre: "+JSON.stringify(p)),console.log("citationsPost: "+JSON.stringify(q)),g.callRegisterCitation(j,p,q)}})}var g=a.plugins.citesupport.citesupport;a.addCommand("mceCite",f),a.addButton("citeaddedit",{icon:!1,text:"Add/Edit citation",onclick:f}),a.addMenuItem("citeaddedit",{icon:!1,text:"AddEdit citation",context:"insert",onclick:f})});